// Prisma Schema for Jadwa Consulting Platform
// MySQL Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User accounts and profiles
model User {
  id         String   @id @default(dbgenerated("(UUID())")) @db.VarChar(36)
  fullName   String   @map("full_name") @db.VarChar(255)
  email      String   @unique @db.VarChar(255)
  phone      String?  @db.VarChar(50)
  passwordHash String @map("password_hash") @db.VarChar(255)
  role       UserRole
  verified   Boolean  @default(false)
  status     UserStatus @default(active)
  avatarUrl  String?  @map("avatar_url") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  consultantProfile Consultant?
  consultationsAsClient Consultation[] @relation("ClientConsultations")
  consultationsAsConsultant Consultation[] @relation("ConsultantConsultations")
  messages Message[]
  studyRequestsAsClient StudyRequest[] @relation("ClientStudyRequests")
  studyRequestsAsConsultant StudyRequest[] @relation("ConsultantStudyRequests")
  payments Payment[]
  payouts Payout[]
  supportTickets SupportTicket[]
  notifications Notification[]
  ratingsAsClient Rating[] @relation("ClientRatings")
  ratingsAsConsultant Rating[] @relation("ConsultantRatings")
  adminLogs AdminLog[]
  processedPayouts Payout[] @relation("ProcessedPayouts")
  assignedTickets SupportTicket[] @relation("AssignedTickets")

  @@map("users")
  @@index([email])
  @@index([role])
}

// Consultant-specific information
model Consultant {
  id             String   @id @default(dbgenerated("(UUID())")) @db.VarChar(36)
  userId         String   @unique @map("user_id") @db.VarChar(36)
  specialization String   @db.VarChar(255)
  experienceYears Int     @default(0) @map("experience_years")
  bio            String?  @db.Text
  rating         Decimal  @default(0.00) @db.Decimal(3, 2)
  totalReviews   Int      @default(0) @map("total_reviews")
  hourlyRate     Decimal  @default(0.00) @map("hourly_rate") @db.Decimal(10, 2)
  verifiedDocs   Boolean  @default(false) @map("verified_docs")
  certificates   Json     @default("[]")
  available      Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("consultants")
  @@index([userId])
}

// Video and chat consultation sessions
model Consultation {
  id              String          @id @default(dbgenerated("(UUID())")) @db.VarChar(36)
  clientId        String          @map("client_id") @db.VarChar(36)
  consultantId    String?         @map("consultant_id") @db.VarChar(36)
  type            ConsultationType
  status          ConsultationStatus @default(pending)
  scheduledAt     DateTime?       @map("scheduled_at")
  durationMinutes Int             @default(60) @map("duration_minutes")
  meetingLink     String?         @map("meeting_link") @db.Text
  price           Decimal         @db.Decimal(10, 2)
  notes           String?         @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")
  completedAt     DateTime?       @map("completed_at")

  // Relations
  client User @relation("ClientConsultations", fields: [clientId], references: [id], onDelete: Cascade)
  consultant User? @relation("ConsultantConsultations", fields: [consultantId], references: [id], onDelete: Cascade)
  messages Message[]
  ratings Rating[]

  @@map("consultations")
  @@index([clientId])
  @@index([consultantId])
}

// Chat messages for chat consultations
model Message {
  id             String   @id @default(uuid())
  consultationId  String   @map("consultation_id") @db.VarChar(36)
  senderId       String   @map("sender_id") @db.VarChar(36)
  message        String   @db.Text
  fileUrl        String?  @map("file_url") @db.Text
  fileName       String?  @map("file_name") @db.VarChar(255)
  read           Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([consultationId])
}

// Feasibility studies and economic reports
model StudyRequest {
  id            String          @id @default(uuid())
  clientId      String          @map("client_id") @db.VarChar(36)
  consultantId  String?         @map("consultant_id") @db.VarChar(36)
  type          StudyRequestType
  title         String          @db.VarChar(255)
  description   String          @db.Text
  details       Json            @default("{}")
  attachments   Json            @default("[]")
  price         Decimal?        @db.Decimal(10, 2)
  durationDays  Int?            @map("duration_days")
  status        StudyRequestStatus @default(pending)
  deliverables  Json            @default("[]")
  createdAt     DateTime        @default(now()) @map("created_at")
  completedAt   DateTime?      @map("completed_at")

  // Relations
  client User? @relation("ClientStudyRequests", fields: [clientId], references: [id], onDelete: Cascade)
  consultant User? @relation("ConsultantStudyRequests", fields: [consultantId], references: [id], onDelete: SetNull)

  @@map("study_requests")
  @@index([clientId])
  @@index([consultantId])
}

// Payment transactions
model Payment {
  id            String        @id @default(uuid())
  userId        String        @map("user_id") @db.VarChar(36)
  relatedId     String        @map("related_id") @db.VarChar(36)
  relatedType   PaymentType
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("SAR") @db.VarChar(10)
  status        PaymentStatus @default(pending)
  paymentMethod String?       @map("payment_method") @db.VarChar(100)
  transactionId String?       @map("transaction_id") @db.VarChar(255)
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
  @@index([userId])
}

// Consultant withdrawal requests
model Payout {
  id           String       @id @default(uuid())
  consultantId String       @map("consultant_id") @db.VarChar(36)
  amount       Decimal      @db.Decimal(10, 2)
  status       PayoutStatus @default(pending)
  bankAccount  Json?
  processedAt  DateTime?    @map("processed_at")
  processedBy  String?      @map("processed_by") @db.VarChar(36)
  notes        String?       @db.Text
  createdAt    DateTime      @default(now()) @map("created_at")

  // Relations
  consultant User @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  processedByUser User? @relation("ProcessedPayouts", fields: [processedBy], references: [id], onDelete: SetNull)

  @@map("payouts")
}

// Customer support tickets
model SupportTicket {
  id          String            @id @default(uuid())
  userId      String            @map("user_id") @db.VarChar(36)
  subject     String            @db.VarChar(255)
  category    TicketCategory
  priority    TicketPriority    @default(medium)
  status      TicketStatus      @default(open)
  description String            @db.Text
  response    String?           @db.Text
  assignedTo  String?           @map("assigned_to") @db.VarChar(36)
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedToUser User? @relation("AssignedTickets", fields: [assignedTo], references: [id], onDelete: SetNull)

  @@map("support_tickets")
}

// In-app notifications
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id") @db.VarChar(36)
  title     String           @db.VarChar(255)
  message   String           @db.Text
  type      NotificationType
  status    NotificationStatus @default(unread)
  actionUrl String?          @map("action_url") @db.Text
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
}

// Consultant ratings and reviews
model Rating {
  id             String   @id @default(uuid())
  consultationId String   @map("consultation_id") @db.VarChar(36)
  clientId       String   @map("client_id") @db.VarChar(36)
  consultantId   String   @map("consultant_id") @db.VarChar(36)
  rating         Int      @db.TinyInt
  review         String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  client User @relation("ClientRatings", fields: [clientId], references: [id], onDelete: Cascade)
  consultant User @relation("ConsultantRatings", fields: [consultantId], references: [id], onDelete: Cascade)

  @@map("ratings")
  @@index([consultantId])
}

// Admin activity logs
model AdminLog {
  id         String   @id @default(uuid())
  adminId    String?   @map("admin_id") @db.VarChar(36)
  action     String    @db.VarChar(255)
  targetType String?   @map("target_type") @db.VarChar(100)
  targetId   String?   @map("target_id") @db.VarChar(36)
  details    Json      @default("{}")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  admin User? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@map("admin_logs")
}

// Enums
enum UserRole {
  client
  consultant
  admin
}

enum UserStatus {
  active
  suspended
  pending
}

enum ConsultationType {
  video
  chat
}

enum ConsultationStatus {
  pending
  confirmed
  in_progress
  completed
  cancelled
}

enum StudyRequestType {
  feasibility_study
  economic_analysis
  financial_report
}

enum StudyRequestStatus {
  pending
  quoted
  approved
  in_progress
  completed
  rejected
}

enum PaymentType {
  consultation
  study
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum PayoutStatus {
  pending
  approved
  processed
  rejected
}

enum TicketCategory {
  technical
  financial
  behavior
  general
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketStatus {
  open
  in_progress
  resolved
  closed
}

enum NotificationType {
  booking
  payment
  report
  support
  system
}

enum NotificationStatus {
  unread
  read
}
